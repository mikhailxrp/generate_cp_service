# Настройка системы авторизации

## Что реализовано

1. **Авторизация через JWT токены**

   - Токен хранится в httpOnly cookie (безопасно)
   - Срок действия токена: 7 дней
   - Автоматическое продление сессии при каждом запросе

2. **Защита роутов**

   - Все страницы закрыты для неавторизованных пользователей
   - Единственная открытая страница: `/login`
   - API роуты защищены и возвращают 401 Unauthorized

3. **Функционал выхода**
   - Кнопка выхода в Header (десктоп и мобильная версия)
   - Полное удаление сессии и редирект на `/login`

## Настройка

### 1. Создайте файл `.env.local` в корне проекта:

```env
# JWT Secret Key для авторизации
# ВАЖНО: Сгенерируйте случайную строку для production!
JWT_SECRET=your-secret-key-change-in-production

# Database (если еще не настроено)
DATABASE_URL=mysql://user:password@localhost:3306/database_name
```

### 2. Создайте пользователя для тестирования:

```bash
npm run create-user
```

Скрипт создаст пользователя:

- Email: `dmihail528@gmail.com`
- Password: `dmihail528@gmail.com`

Или отредактируйте `scripts/create-user.js` для создания своего пользователя.

### 3. Запустите приложение:

```bash
npm run dev
```

## Использование

1. При попытке зайти на любую страницу неавторизованный пользователь будет перенаправлен на `/login`
2. После успешного входа пользователь получит доступ ко всем страницам
3. Для выхода нажмите кнопку со стрелкой в правом верхнем углу

## Структура файлов

```
src/
├── lib/
│   └── auth.js                 # Функции для работы с сессиями (создание, проверка, удаление)
├── app/
│   └── actions/
│       ├── login.js           # Server action для авторизации
│       └── logout.js          # Server action для выхода
└── components/
    ├── login-form/
    │   └── LoginForm.jsx      # Форма входа
    └── header/
        └── Header.jsx         # Header с кнопкой выхода

middleware.js                   # Middleware для защиты всех роутов
```

## Безопасность

✅ Пароли хэшируются с помощью bcryptjs
✅ JWT токены подписываются секретным ключом
✅ Токены хранятся в httpOnly cookies (защита от XSS)
✅ Токены имеют срок действия
✅ Middleware проверяет авторизацию на каждом запросе

## Расширение функционала

### Добавление регистрации:

1. Создайте `src/app/(auth)/register/page.jsx`
2. Создайте `src/app/actions/register.js`
3. Добавьте `/register` в список разрешенных роутов в `middleware.js`

### Добавление восстановления пароля:

1. Добавьте поле `resetToken` в таблицу `users`
2. Создайте эндпоинт для отправки email с токеном
3. Создайте страницу сброса пароля

### Добавление ролей и разрешений:

В таблице `users` уже есть поле `role`. Можно расширить middleware для проверки прав доступа к определенным страницам.
