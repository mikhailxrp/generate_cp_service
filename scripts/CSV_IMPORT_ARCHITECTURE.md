# 🏗️ Архитектура системы CSV-импорта

## 📊 Общая схема

```
┌─────────────────────────────────────────────────────────────────┐
│                      CSV FILES (./data/)                        │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │ INVERTERS    │  │  MODULES     │  │    ESS       │   ...    │
│  │    .csv      │  │    .csv      │  │    .csv      │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                   CSV IMPORT SCRIPTS                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │ importInv... │  │ importMod... │  │ importEss... │   ...    │
│  │ FromCsv.js   │  │ FromCsv.js   │  │ FromCsv.js   │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
│         │                  │                  │                 │
│         └──────────────────┼──────────────────┘                 │
│                            ▼                                    │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │         MAPPING FUNCTIONS (категория-специфичные)       │   │
│  │  mapInverterRowToPriceItem, mapModuleRowToPriceItem... │   │
│  └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              csvImportHelpers.js (CORE ENGINE)                  │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  importFromCsv() — универсальная функция импорта         │ │
│  │    • Читает CSV stream-ом                                 │ │
│  │    • Вызывает маппинг для каждой строки                   │ │
│  │    • Показывает прогресс-бар                              │ │
│  │    • Собирает статистику                                  │ │
│  └───────────────────────────────────────────────────────────┘ │
│                              │                                  │
│  ┌───────────────────────────┼─────────────────────────────┐   │
│  │  PARSERS                  │  UPSERT                     │   │
│  │  • toNum()                │  • upsertPriceItem()        │   │
│  │  • toInt()                │    (raw SQL)                │   │
│  │  • toBool()               │                             │   │
│  │  • parseStockFlag()       │                             │   │
│  │  • parsePriority()        │                             │   │
│  │  • parseGridType()        │                             │   │
│  │  • parseBatterySupport()  │                             │   │
│  └───────────────────────────┴─────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    DRIZZLE ORM (db)                             │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │  db.execute(INSERT ... ON DUPLICATE KEY UPDATE ...)      │ │
│  └───────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      MySQL DATABASE                             │
│  ┌──────────────────┐           ┌──────────────────┐           │
│  │ price_categories │           │   price_items    │           │
│  │  • id            │           │   • id           │           │
│  │  • code (PK)     │◄──────────│   • category_id  │           │
│  │  • title         │   FK      │   • sku (UNIQUE) │           │
│  │  • group_code    │           │   • title        │           │
│  └──────────────────┘           │   • price_rub    │           │
│                                 │   • stock        │           │
│                                 │   • priority     │           │
│                                 │   • attrs (JSON) │           │
│                                 └──────────────────┘           │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🔄 Поток данных (Data Flow)

```
CSV Row  →  Парсинг  →  Маппинг  →  UPSERT  →  MySQL
  │           │           │           │          │
  │         toNum()      attrs:     INSERT    price_items
  │         toInt()      {          ...         table
  │         toBool()      electrical,  ON DUP
  │                       mechanical,  KEY UPD
  │                       compat,
  │                       bos,
  │                       meta
  │                      }
  │
  └─ SKU, Наименование, Цена_базовая, Наличие, Приоритет...
```

---

## 🧩 Компоненты системы

### 1. CSV Files (`./data/`)
**Роль:** Источник данных  
**Формат:** CSV UTF-8 с заголовками  
**Пример:** `PRICE_INVERTERS.csv`

### 2. Import Scripts (`scripts/importXxxFromCsv.js`)
**Роль:** Точка входа для каждой категории  
**Состав:**
- Конфигурация (CSV_PATH, CATEGORY_CODE, TYPE_CODE)
- Функция маппинга (скопирована из Excel-скрипта)
- Вызов `importFromCsv()`

### 3. Core Engine (`csvImportHelpers.js`)
**Роль:** Универсальная инфраструктура  
**Функции:**
- `importFromCsv()` — главный каркас импорта
- `upsertPriceItem()` — INSERT ... ON DUPLICATE KEY UPDATE
- Парсеры: `toNum`, `toInt`, `toBool`, `parseStockFlag`, `parsePriority`
- Специфичные парсеры: `parseGridType`, `parseBatterySupport`
- Loader: анимированный прогресс-бар

### 4. Mapping Functions
**Роль:** Преобразование CSV-строки в объект price_items  
**Особенность:** Идентичны Excel-скриптам (та же структура attrs)  
**Пример:** `mapInverterRowToPriceItem(row, categoryId)`

### 5. Database Layer
**Роль:** Хранение данных  
**Таблицы:**
- `price_categories` — категории товаров
- `price_items` — товары с ценами и атрибутами

---

## 🔐 UPSERT-механизм

```sql
INSERT INTO price_items (
  category_id, type_code, sku, title, 
  price_rub, currency, stock, priority, 
  warehouse_region, lead_days, spec_url, 
  comment, attrs
) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
ON DUPLICATE KEY UPDATE
  category_id = VALUES(category_id),
  type_code = VALUES(type_code),
  title = VALUES(title),
  price_rub = VALUES(price_rub),
  currency = VALUES(currency),
  stock = VALUES(stock),
  priority = VALUES(priority),
  warehouse_region = VALUES(warehouse_region),
  lead_days = VALUES(lead_days),
  spec_url = VALUES(spec_url),
  comment = VALUES(comment),
  attrs = VALUES(attrs),
  updated_at = CURRENT_TIMESTAMP
```

**Поведение:**
- **SKU новый** → INSERT (вставка)
- **SKU существует** → UPDATE (обновление всех полей кроме id и sku)

---

## 📋 Структура attrs (JSON)

```typescript
{
  electrical?: {
    // Электрические параметры
    ac_power_kw?: number;
    phases?: number;
    grid_type?: "on_grid" | "hybrid" | "off_grid";
    mppt_count?: number;
    capacity_kwh?: number;
    // ... другие поля
  },
  
  mechanical?: {
    // Механические параметры
    weight_kg?: number;
    dimensions_mm?: string;
    mech_load_pa?: number;
    // ... другие поля
  },
  
  compat?: {
    // Совместимость и применимость
    battery_support?: "lv" | "hv" | "none";
    roof_applicable?: boolean;
    ground_applicable?: boolean;
    segment_b2c?: boolean;
    segment_b2b?: boolean;
    // ... другие поля
  },
  
  bos?: {
    // Обвязка и работы
    dc_cable_single_m_per_kw?: number;
    work_cost_1?: number;
    work_cost_2?: number;
    deg_cost_per_cycle_rub?: number;
    // ... другие поля
  },
  
  meta?: {
    // Вспомогательные данные
    brand?: string;
    raw_category?: string;
    stock_raw?: string;
    priority_raw?: string;
    warranty_years?: number;
    // ... другие поля
  }
}
```

**⚠️ Важно:** Структура верхнего уровня (5 разделов) ФИКСИРОВАНА и не меняется между категориями!

---

## 🔄 Жизненный цикл импорта

```
┌─────────────────────────────────────────────────────────────┐
│  1. ИНИЦИАЛИЗАЦИЯ                                           │
│     • Подключение к БД                                      │
│     • Получение categoryId из price_categories по code      │
│     • Запуск loader (прогресс-бар)                          │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  2. ЧТЕНИЕ CSV                                              │
│     • Stream через fs.createReadStream + csv-parse          │
│     • Автоопределение кодировки (BOM support)               │
│     • Пропуск пустых строк                                  │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  3. ОБРАБОТКА КАЖДОЙ СТРОКИ (for await of parser)           │
│     • Проверка наличия SKU и Наименования                   │
│     • Вызов mapRowToPriceItem(row, categoryId)              │
│     • Парсинг чисел, булевых значений, специфичных полей    │
│     • Формирование объекта attrs                            │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  4. ПРОВЕРКА НА СУЩЕСТВОВАНИЕ                               │
│     • SELECT id FROM price_items WHERE sku = ?              │
│     • existing ? UPDATE : INSERT                            │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  5. UPSERT                                                  │
│     • db.execute(INSERT ... ON DUPLICATE KEY UPDATE ...)    │
│     • Обновление счётчиков: inserted++ или updated++        │
│     • Обработка ошибок: errors.push({ sku, error })         │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  6. ЗАВЕРШЕНИЕ                                              │
│     • Остановка loader                                      │
│     • Вывод статистики: inserted, updated, skipped, errors  │
│     • Показ первых 10 ошибок (если есть)                    │
└─────────────────────────────────────────────────────────────┘
```

---

## 🎯 Принципы дизайна

### 1. Единообразие (Consistency)
- **Та же структура attrs** для всех категорий (5 разделов верхнего уровня)
- **Те же парсеры** для всех импортеров
- **Те же функции маппинга**, что в Excel-импортерах

### 2. Переиспользование (Reusability)
- **Универсальная функция** `importFromCsv()` для всех категорий
- **Общие парсеры** в `csvImportHelpers.js`
- **Шаблоны** для быстрого создания новых импортеров

### 3. Безопасность (Safety)
- **UPSERT** вместо INSERT — не падает на дубликатах
- **Обработка ошибок** — продолжает работу при ошибке в одной строке
- **Валидация** — пропуск строк без SKU/Наименования

### 4. UX (User Experience)
- **Прогресс-бар** с анимацией
- **Детальная статистика** после импорта
- **Читаемые логи** с эмодзи и форматированием

### 5. Расширяемость (Extensibility)
- **Шаблоны** для новых категорий
- **Модульная структура** — легко добавить новый парсер
- **Документация** — 7 файлов с примерами

---

## 🧪 Тестирование

### Стратегия тестирования:

```
1. UNIT-тесты парсеров
   toNum("123,45") === 123.45
   toBool("Да") === true
   parseStockFlag("Нет") === 0

2. INTEGRATION-тесты маппинга
   mapInverterRowToPriceItem(mockRow, categoryId)
   → проверка структуры attrs

3. E2E-тест импорта
   • Создать тестовый CSV с 5-10 строками
   • Запустить импорт
   • Проверить результат в БД
   • Проверить статистику (inserted, updated, skipped)
```

---

## 📊 Мониторинг и логирование

### Уровни логирования:

```javascript
// 1. SILENT (по умолчанию)
await importFromCsv({ ..., verbose: false });
// Показывает только прогресс-бар и итоговую статистику

// 2. VERBOSE (для отладки)
await importFromCsv({ ..., verbose: true });
// Показывает каждую вставку/обновление:
// ➕ Добавлено: SKU-12345
// 🔄 Обновлено: SKU-67890
```

### Метрики:

```typescript
{
  inserted: number;      // Добавлено новых записей
  updated: number;       // Обновлено существующих
  skipped: number;       // Пропущено (ошибки/пустые строки)
  totalProcessed: number;// Всего обработано строк
  errors: Array<{        // Массив ошибок
    sku: string;
    error: string;
  }>;
}
```

---

## 🔗 Связь с другими системами

```
┌─────────────────────────────────────────────────────────────┐
│  EXCEL-ИМПОРТ (scripts/importInverters.js и т.д.)          │
│     • Читает XLSX напрямую                                  │
│     • Те же функции маппинга                                │
│     • Та же структура attrs                                 │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ Совместимы
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  CSV-ИМПОРТ (scripts/importInvertersFromCsv.js и т.д.)     │
│     • Читает CSV stream-ом                                  │
│     • Использует те же функции маппинга                     │
│     • Та же структура attrs                                 │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ Оба пишут в
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  БД (price_items)                                           │
│     • Единая схема                                          │
│     • UPSERT по SKU                                         │
│     • attrs в JSON                                          │
└─────────────────────────────────────────────────────────────┘
```

---

## 🎯 Зависимости

```json
{
  "csv-parse": "^6.1.0",    // Парсинг CSV (stream)
  "drizzle-orm": "^0.44.6", // ORM для MySQL
  "mysql2": "^3.15.3"       // MySQL-драйвер
}
```

---

## 📚 Документация (архитектура)

- **CSV_IMPORT_ARCHITECTURE.md** (этот файл) — архитектура системы
- **CSV_IMPORT_README.md** — общий обзор
- **csvImportHelpers.js** — исходный код (380+ строк)

---

**🏗️ Архитектура спроектирована с учётом:**
- ✅ Совместимости с Excel-импортом
- ✅ Переиспользования кода
- ✅ Расширяемости
- ✅ Безопасности (UPSERT)
- ✅ UX (прогресс-бар, статистика)

---

_Версия: 2.0_  
_Дата: 2025-11-19_



